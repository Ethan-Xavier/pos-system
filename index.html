<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Waiter POS System with Firebase</title>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
<style>
body {
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  background: #f4f4f4;
  padding: 20px;
  display: flex;
  flex-direction: column;
  align-items: center;
}
.order-box {
  background: #0062ca;
  padding: 25px;
  border-radius: 15px;
  box-shadow: 0 10px 25px rgba(0,0,0,0.2);
  width: 350px;
  color: #fff;
  margin-bottom: 20px;
}
.order-box h2 { text-align: center; margin-bottom: 20px; }
select, input { width: 100%; padding: 12px; margin-bottom: 12px; border-radius: 10px; border: none; font-size: 16px; outline: none; }
button {
  padding: 10px 15px;
  border: none;
  border-radius: 10px;
  cursor: pointer;
  font-size: 15px;
  transition: 0.2s;
  display: flex;
  align-items: center;
  justify-content: center;
}
.add-btn { width: 100%; background: #28a745; color: #fff; font-weight: bold; }
.add-btn:hover { background: #218838; }
.tables-container { display: flex; flex-wrap: wrap; justify-content: center; gap: 15px; width: 100%; }
.table-box {
  background: #fff;
  color: #333;
  width: 300px;
  padding: 15px;
  border-radius: 15px;
  box-shadow: 0 8px 20px rgba(0,0,0,0.2);
  max-height: 600px;
  overflow-y: auto;
  position: relative;
}
.table-box h3 { text-align: center; margin-bottom: 10px; }
.item-box { display: flex; justify-content: space-between; align-items: center; border-radius: 10px; padding: 8px; margin: 5px 0; transition: transform 0.2s; }
.pending-order { background-color: #fff3cd; animation: pulsePending 2s infinite; }
.served-order { background-color: #d4edda; }
.item-info { display: flex; flex-direction: column; gap: 2px; }
.item-buttons button { margin-left: 5px; font-size: 14px; border-radius: 8px; }
.served-btn { background: #28a745; color: #fff; }
.cancel-btn { background: #dc3545; color: #fff; }
.close-btn { background: #6c757d; color: #fff; font-weight: bold; width: 100%; margin-top: 10px; }
.person-box { background: #e0e0e0; padding: 8px; border-radius: 10px; margin-bottom: 10px; }
@keyframes glow { 0% { box-shadow: 0 0 5px #28a745; } 50% { box-shadow: 0 0 15px #28a745; } 100% { box-shadow: 0 0 5px #28a745; } }
@keyframes pulsePending { 0% { transform: scale(1); } 50% { transform: scale(1.03); } 100% { transform: scale(1); } }
.item-box.new-order { animation: glow 1s ease-in-out; }
@media (max-width: 768px) {
  .order-box, .table-box { width: 90%; }
  .tables-container { flex-direction: column; align-items: center; }
}
</style>
</head>
<body>
<div class="order-box">
<h2><i class="fas fa-utensils"></i> Take Order</h2>
<select id="tableSelect"><option value="" disabled selected>Select Table</option></select>
<input type="text" id="personDesc" placeholder="Person / Description (optional)">
<select id="typeSelect"><option value="" disabled selected>Select Type</option><option value="food">Food</option><option value="drink">Drink</option></select>
<select id="itemSelect"><option value="" disabled selected>Select Item</option></select>
<select id="priceSelect" style="display:none;"></select>
<input type="number" id="quantity" placeholder="Quantity" min="1" value="1">
<button id="addItemBtn" class="add-btn"><i class="fas fa-plus"></i> Add Item</button>
</div>
<div id="tablesContainer" class="tables-container"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyC6VdctOXcT-qHaLJs1gEzwzVv5AdK5e0w",
  authDomain: "pos-system-9a056.firebaseapp.com",
  projectId: "pos-system-9a056",
  storageBucket: "pos-system-9a056.firebasestorage.app",
  messagingSenderId: "701001104012",
  appId: "1:701001104012:web:294967faec11a627c819a9"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const tablesContainer = document.getElementById('tablesContainer');
const typeSelect = document.getElementById('typeSelect');
const itemSelect = document.getElementById('itemSelect');
const priceSelect = document.getElementById('priceSelect');
const tableSelect = document.getElementById('tableSelect');
const personDesc = document.getElementById('personDesc');

for(let i=1;i<=13;i++){ tableSelect.innerHTML += `<option value="${i}">${i}</option>`; }

const menuItems = {
  food: [
    {item:'Salsicha',price:[200]}, {item:'Sasicha c/ Queijo',price:[300]}, {item:'Worse',price:[200]},
    {item:'Babalaza',price:[300]}, {item:'Rabada',price:[200]}, {item:'Língua',price:[200]},
    {item:'Brisket',price:[400]}, {item:'Figado de vaca',price:[300]}, {item:'Cordornizes',price:[350]},
    {item:'Moela',price:[300]}, {item:'Sopa de legumes',price:[270]}, {item:'Sopa de Feijão',price:[220]},
    {item:'Salgadinhos (dose)',price:[100]}, {item:'Pizza Grande',price:[600]}, {item:'Pizza Pequena',price:[350]},
    {item:'Picanha',price:[500]}, {item:'T-Bone',price:[450]}, {item:'Lombo',price:[300]}, {item:'Bife',price:[600]},
    {item:'Bitoque',price:[500]}, {item:'Prego Completo',price:[250]}, {item:'Prego no Prato',price:[300]},
    {item:'Lasanha',price:[600]}, {item:'Pernil',price:[350]}, {item:'Carne de Porco',price:[350]},
    {item:'Costuleta',price:[500,850]}, {item:'Frango Inteiro',price:[700]}, {item:'Meio Frango',price:[350]},
    {item:'Dose de Frango',price:[250]}, {item:'Peixe c/m legumes',price:[600]}
  ],
  drink: [
    {item:'2M Grande',price:[70]}, {item:'Savana',price:[80]}, {item:'Heineken',price:[80]}, {item:'Heineken Grande',price:[70]},
    {item:'Impala',price:[60]}, {item:'Txilar a lata',price:[60]}, {item:'Txilar garrafa',price:[70]},
    {item:'Corona',price:[100]}, {item:'Brutal a garafa',price:[80]}, {item:'Brutal a lata',price:[100]},
    {item:'Água Tônica',price:[70]}, {item:'May fair',price:[90]}, {item:'Flying Fish',price:[80]}, {item:'Lite',price:[80]},
    {item:'Black Crown',price:[80]}, {item:'Stella',price:[100]}, {item:'Bernina',price:[90]}, {item:'Whisky Jameson',price:[150,1250]},
    {item:'Amarula',price:[150,850]}, {item:'Paul Cluver Branco',price:[850]}, {item:'Roodberg Black',price:[900]},
    {item:'Vinho da Casa',price:[200]}, {item:'Refresco 2L',price:[110]}, {item:'Refresco 1L',price:[70]}, {item:'Refresco a lata',price:[70]},
    {item:'Sumo compal',price:[70]}, {item:'Sumo compal 1L',price:[140]}, {item:'Chá Simples',price:[50]}
  ]
};

let tables = {};
let mergedHistory = {}; // stores previous state for splitting merged sub-orders

typeSelect.addEventListener('change',()=>{
  const type = typeSelect.value;
  itemSelect.innerHTML='<option value="" disabled selected>Select Item</option>';
  menuItems[type].forEach(menuItem=>{
    const option=document.createElement('option');
    option.value = menuItem.item;
    option.textContent = menuItem.item;
    itemSelect.appendChild(option);
  });
  priceSelect.style.display='none';
});

itemSelect.addEventListener('change',()=>{
  const type = typeSelect.value;
  const menuItem = menuItems[type].find(m=>m.item===itemSelect.value);
  if(menuItem.price.length>1){
    priceSelect.innerHTML='<option value="" disabled selected>Select Price</option>';
    menuItem.price.forEach(p=>{
      const opt = document.createElement('option');
      opt.value = p;
      opt.textContent = p + 'mts';
      priceSelect.appendChild(opt);
    });
    priceSelect.style.display='block';
  } else { priceSelect.style.display='none'; }
});

document.getElementById('addItemBtn').addEventListener('click', async ()=>{
  const tableNum = tableSelect.value;
  const type = typeSelect.value;
  const itemName = itemSelect.value;
  const description = personDesc.value.trim() || 'Person';
  let price = priceSelect.style.display==='block'?parseInt(priceSelect.value):menuItems[type].find(m=>m.item===itemName).price[0];
  const quantity = parseInt(document.getElementById('quantity').value);

  if(!tableNum||!type||!itemName||quantity<1||(priceSelect.style.display==='block' && !priceSelect.value)){ alert('Select all options'); return; }

  let tableID = Object.keys(tables).find(id=>tables[id].table==tableNum && tables[id].tableStatus==='opened');
  if(!tableID){
    tableID = 'TABLE-'+Date.now();
    tables[tableID] = { id:tableID, table:tableNum, tableStatus:'opened', time: new Date().toISOString(), subOrders: [] };
  }

  let subOrder = tables[tableID].subOrders.find(s=>s.description===description);
  if(!subOrder){
    subOrder = { personID: 'PERSON-'+Date.now(), description, items: [], totalPrice: 0 };
    tables[tableID].subOrders.push(subOrder);
  }

  subOrder.items.push({ item:itemName, price, quantity, status:'pending', time: new Date().toISOString(), isNew:true });
  subOrder.totalPrice = subOrder.items.reduce((sum,i)=>sum+i.price*i.quantity,0);

  await saveTablesToFirebase();
  renderTables();
});

async function saveTablesToFirebase(){
  const tablesDocRef = doc(db,'posData','tables');
  for(let key in tables){ if(tables[key].subOrders.length===0) delete tables[key]; }
  await setDoc(tablesDocRef,{tables});
}

function renderTables(){
  tablesContainer.innerHTML='';
  Object.values(tables).filter(t=>t.tableStatus==='opened').sort((a,b)=>b.time.localeCompare(a.time)).forEach(tableOrder=>{
    const tableBox=document.createElement('div');
    tableBox.className='table-box';
    tableBox.innerHTML=`<h3>Table ${tableOrder.table}</h3>`;

    tableOrder.subOrders.forEach(sub=>{
      const personDiv = document.createElement('div');
      personDiv.className='person-box';
      personDiv.innerHTML=`<strong>${sub.description}</strong> | Total: ${sub.totalPrice} mts`;

      // Merge / Split buttons
      const actionDiv = document.createElement('div');
      actionDiv.style.marginBottom='5px';
      actionDiv.innerHTML = `
        <button class="merge-btn">Merge</button>
        <button class="split-btn">Split</button>
      `;
      personDiv.appendChild(actionDiv);

      actionDiv.querySelector('.merge-btn').addEventListener('click', async ()=>{
        if(tableOrder.subOrders.length<2) { alert('No sub-orders to merge'); return; }
        mergedHistory[tableOrder.id] = JSON.parse(JSON.stringify(tableOrder.subOrders));
        const first = tableOrder.subOrders[0];
        for(let i=1;i<tableOrder.subOrders.length;i++){
          first.items = first.items.concat(tableOrder.subOrders[i].items);
          first.description += ' + ' + tableOrder.subOrders[i].description;
          first.totalPrice = first.items.reduce((sum,i)=>sum+i.price*i.quantity,0);
        }
        tableOrder.subOrders = [first];
        await saveTablesToFirebase();
        renderTables();
      });

      actionDiv.querySelector('.split-btn').addEventListener('click', async ()=>{
        if(mergedHistory[tableOrder.id]){
          tableOrder.subOrders = JSON.parse(JSON.stringify(mergedHistory[tableOrder.id]));
          delete mergedHistory[tableOrder.id];
          await saveTablesToFirebase();
          renderTables();
        } else { alert('No merged sub-orders to split'); }
      });

      sub.items.forEach(item=>{
        const itemDiv=document.createElement('div');
        itemDiv.className='item-box '+(item.status==='pending'?'pending-order':'served-order');
        if(item.isNew){ itemDiv.classList.add('new-order'); setTimeout(()=>{item.isNew=false; renderTables();},1000); }
        itemDiv.innerHTML=`
          <div class="item-info">
            <strong>${item.item} x${item.quantity}</strong>
            <span>[${item.status}]</span>
            <span>${item.price*item.quantity} mts</span>
          </div>
          <div class="item-buttons">
            ${item.status==='pending'?`<button class="served-btn">Served</button>`:''}
            <button class="cancel-btn">Cancel</button>
          </div>
        `;
        if(item.status==='pending') itemDiv.querySelector('.served-btn').addEventListener('click', async ()=>{
          item.status='served';
          await saveTablesToFirebase();
          renderTables();
        });
        itemDiv.querySelector('.cancel-btn').addEventListener('click', async ()=>{
          const idx = sub.items.indexOf(item);
          if(idx!==-1) sub.items.splice(idx,1);
          sub.totalPrice = sub.items.reduce((sum,i)=>sum+i.price*i.quantity,0);
          if(sub.items.length===0){
            const sIdx = tableOrder.subOrders.indexOf(sub);
            if(sIdx!==-1) tableOrder.subOrders.splice(sIdx,1);
          }
          if(tableOrder.subOrders.length===0) delete tables[tableOrder.id];
          await saveTablesToFirebase();
          renderTables();
        });
        personDiv.appendChild(itemDiv);
      });

      tableBox.appendChild(personDiv);
    });

    const closeBtn=document.createElement('button');
    closeBtn.textContent='Close Table';
    closeBtn.className='close-btn';
    closeBtn.addEventListener('click', async ()=>{
      if(tableOrder.subOrders.some(s=>s.items.some(i=>i.status==='pending'))){
        alert('All items must be served!'); return;
      }
      tableOrder.tableStatus='closed';
      await saveTablesToFirebase();
      renderTables();
    });

    tableBox.appendChild(closeBtn);
    tablesContainer.appendChild(tableBox);
  });
}

const tablesDocRef = doc(db,'posData','tables');
onSnapshot(tablesDocRef,(snapshot)=>{
  const data = snapshot.data();
  if(data && data.tables){
    tables = data.tables;
    renderTables();
  }
});
</script>
</body>
</html>
