<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Waiter POS — TRUE MERGE (Merged Order)</title>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
<style>
  :root{--primary:#0062ca;--green:#28a745;--muted:#f4f4f4}
  body{font-family:Segoe UI, Tahoma, Geneva, Verdana, sans-serif;background:var(--muted);padding:18px;display:flex;flex-direction:column;align-items:center;gap:12px}
  .order-box{background:var(--primary);padding:18px;border-radius:12px;color:#fff;width:380px;box-shadow:0 8px 24px rgba(0,0,0,.12)}
  .order-box h2{margin:0 0 10px;font-size:18px;text-align:center}
  input,select{width:100%;padding:9px;margin:6px 0;border-radius:8px;border:none;font-size:15px;outline:none}
  .add-btn{background:var(--green);color:#fff;border-radius:8px;padding:10px;font-weight:700;cursor:pointer;border:none}
  .tables-container{display:flex;flex-wrap:wrap;gap:14px;justify-content:center;width:100%}
  .table-box{background:#fff;padding:12px;border-radius:12px;width:340px;box-shadow:0 8px 20px rgba(0,0,0,.12);max-height:640px;overflow:auto}
  .table-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
  .table-total{font-weight:700}
  .person-box{background:#f0f0f0;padding:8px;border-radius:10px;margin-bottom:8px}
  .person-actions{display:flex;gap:6px;margin-top:6px;flex-wrap:wrap}
  .item-box{display:flex;justify-content:space-between;align-items:center;padding:8px;border-radius:8px;margin:6px 0;background:#fff}
  .pending{background:#fff7e6}
  .served{background:#e9f7ee}
  button.small{padding:6px 8px;border-radius:8px;border:none;cursor:pointer}
  .served-btn{background:var(--green);color:#fff}
  .cancel-btn{background:#dc3545;color:#fff}
  .merge-btn{background:#007bff;color:#fff}
  .split-btn{background:#ffc107;color:#222}
  .move-select{padding:6px;border-radius:6px}
  .low-stock{color:#d9534f;font-weight:700;font-size:13px}
  .note{font-size:13px;color:#666;margin-top:6px}
  .controls-row{display:flex;gap:8px;align-items:center;margin-bottom:8px;flex-wrap:wrap}
  @media(max-width:760px){ .order-box,.table-box{width:92%} .tables-container{flex-direction:column;align-items:center} }
</style>
</head>
<body>

<div class="order-box">
  <h2><i class="fas fa-utensils"></i> Waiter POS</h2>

  <label>Table</label>
  <select id="tableSelect"><option value="" disabled selected>Select table</option></select>

  <label>Description (person / note)</label>
  <input id="description" placeholder="e.g. John / Veggie" />

  <label>Type</label>
  <select id="typeSelect"><option value="" disabled selected>Select type</option><option value="food">Food</option><option value="drink">Drink</option></select>

  <label>Item</label>
  <select id="itemSelect"><option value="" disabled selected>Select item</option></select>

  <select id="priceSelect" style="display:none"></select>

  <label>Quantity</label>
  <input id="quantity" type="number" min="1" value="1" />

  <div style="display:flex;gap:8px;align-items:center">
    <button id="addItemBtn" class="add-btn"><i class="fas fa-plus"></i> Add Item</button>
    <div id="stockNote" style="margin-left:8px"></div>
  </div>

  <div class="note">Inventory updates on add. Canceling items restores stock. Merge produces one real sub-order named "Merged Order".</div>
</div>

<div id="tablesContainer" class="tables-container"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
import { getFirestore, doc, setDoc, onSnapshot, getDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

/* -------------------------
   Firebase config — your config
   ------------------------- */
const firebaseConfig = {
  apiKey: "AIzaSyC6VdctOXcT-qHaLJs1gEzwzVv5AdK5e0w",
  authDomain: "pos-system-9a056.firebaseapp.com",
  projectId: "pos-system-9a056",
  storageBucket: "pos-system-9a056.firebasestorage.app",
  messagingSenderId: "701001104012",
  appId: "1:701001104012:web:294967faec11a627c819a9"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

/* -------------------------
   UI elements
   ------------------------- */
const tableSelect = document.getElementById('tableSelect');
const typeSelect = document.getElementById('typeSelect');
const itemSelect = document.getElementById('itemSelect');
const priceSelect = document.getElementById('priceSelect');
const quantityInput = document.getElementById('quantity');
const descriptionInput = document.getElementById('description');
const addItemBtn = document.getElementById('addItemBtn');
const tablesContainer = document.getElementById('tablesContainer');
const stockNote = document.getElementById('stockNote');

/* -------------------------
   Menu data
   ------------------------- */
const menuItems = {
  food: [
    {item:'Salsicha',price:[200]}, {item:'Sasicha c/ Queijo',price:[300]}, {item:'Worse',price:[200]},
    {item:'Babalaza',price:[300]}, {item:'Rabada',price:[200]}, {item:'Língua',price:[200]},
    {item:'Brisket',price:[400]}, {item:'Figado de vaca',price:[300]}, {item:'Cordornizes',price:[350]},
    {item:'Moela',price:[300]}, {item:'Sopa de legumes',price:[270]}, {item:'Sopa de Feijão',price:[220]},
    {item:'Salgadinhos (dose)',price:[100]}, {item:'Pizza Grande',price:[600]}, {item:'Pizza Pequena',price:[350]},
    {item:'Picanha',price:[500]}, {item:'T-Bone',price:[450]}, {item:'Lombo',price:[300]}, {item:'Bife',price:[600]},
    {item:'Bitoque',price:[500]}, {item:'Prego Completo',price:[250]}, {item:'Prego no Prato',price:[300]},
    {item:'Lasanha',price:[600]}, {item:'Pernil',price:[350]}, {item:'Carne de Porco',price:[350]},
    {item:'Costuleta',price:[500,850]}, {item:'Frango Inteiro',price:[700]}, {item:'Meio Frango',price:[350]},
    {item:'Dose de Frango',price:[250]}, {item:'Peixe c/m legumes',price:[600]}
  ],
  drink: [
    {item:'2M Grande',price:[70]}, {item:'Savana',price:[80]}, {item:'Heineken',price:[80]}, {item:'Heineken Grande',price:[70]},
    {item:'Impala',price:[60]}, {item:'Txilar a lata',price:[60]}, {item:'Txilar garrafa',price:[70]},
    {item:'Corona',price:[100]}, {item:'Brutal a garafa',price:[80]}, {item:'Brutal a lata',price:[100]},
    {item:'Água Tônica',price:[70]}, {item:'May fair',price:[90]}, {item:'Flying Fish',price:[80]}, {item:'Lite',price:[80]},
    {item:'Black Crown',price:[80]}, {item:'Stella',price:[100]}, {item:'Bernina',price:[90]}, {item:'Whisky Jameson',price:[150,1250]},
    {item:'Amarula',price:[150,850]}, {item:'Paul Cluver Branco',price:[850]}, {item:'Roodberg Black',price:[900]},
    {item:'Vinho da Casa',price:[200]}, {item:'Refresco 2L',price:[110]}, {item:'Refresco 1L',price:[70]}, {item:'Refresco a lata',price:[70]},
    {item:'Sumo compal',price:[70]}, {item:'Sumo compal 1L',price:[140]}, {item:'Chá Simples',price:[50]}
  ]
};

/* -------------------------
   Local state
   ------------------------- */
let tables = {};          // persisted under posData/tables
let mergedHistory = {};   // backup for true-split: mergedHistory[tableID] = [...originalSubOrders]
let stock = {};           // persisted under posData/stock (itemName -> qty)

/* -------------------------
   Firestore refs
   ------------------------- */
const tablesDocRef = doc(db,'posData','tables');
const stockDocRef = doc(db,'posData','stock');

/* -------------------------
   Initialize docs if missing
   ------------------------- */
(async function initIfEmpty(){
  const tSnap = await getDoc(tablesDocRef);
  if(!tSnap.exists()) await setDoc(tablesDocRef, { tables: {} });
  const sSnap = await getDoc(stockDocRef);
  if(!sSnap.exists()){
    // create default stock 20 for each menu item
    for(const k of ['food','drink']){
      menuItems[k].forEach(m => { stock[m.item] = 20; });
    }
    await setDoc(stockDocRef, { stock });
  }
})();

/* -------------------------
   Subscribe to stock and tables (real-time)
   ------------------------- */
onSnapshot(stockDocRef, snap=>{
  const data = snap.data();
  if(data && data.stock) stock = data.stock;
  renderStockNote();
});

onSnapshot(tablesDocRef, snap=>{
  const data = snap.data();
  tables = (data && data.tables) ? data.tables : {};
  renderTables();
});

/* -------------------------
   Helpers: save
   ------------------------- */
async function saveTablesToFirebase(){
  // cleanup empty subOrders
  for(const key in tables){
    if(!tables[key].subOrders || tables[key].subOrders.length===0) delete tables[key];
    else tables[key].subOrders = tables[key].subOrders.filter(s=>s.items && s.items.length>0);
  }
  await setDoc(tablesDocRef, { tables });
}

async function saveStockToFirebase(){
  await setDoc(stockDocRef, { stock });
}

/* -------------------------
   Populate table select (1..13)
   ------------------------- */
for(let i=1;i<=13;i++){
  const opt = document.createElement('option'); opt.value=i; opt.textContent=i;
  tableSelect.appendChild(opt);
}

/* -------------------------
   Type -> Item population
   ------------------------- */
typeSelect.addEventListener('change', ()=>{
  itemSelect.innerHTML = '<option value="" disabled selected>Select item</option>';
  const arr = menuItems[typeSelect.value] || [];
  arr.forEach(m=>{
    const opt = document.createElement('option'); opt.value=m.item; opt.textContent=m.item;
    itemSelect.appendChild(opt);
  });
  priceSelect.style.display = 'none';
});

/* -------------------------
   Show price options if multiple
   ------------------------- */
itemSelect.addEventListener('change', ()=>{
  const arr = menuItems[typeSelect.value] || [];
  const menuItem = arr.find(m => m.item === itemSelect.value);
  if(menuItem && menuItem.price && menuItem.price.length > 1){
    priceSelect.innerHTML = '<option value="" disabled selected>Select price</option>';
    menuItem.price.forEach(p => {
      const opt = document.createElement('option'); opt.value = p; opt.textContent = p + ' mts';
      priceSelect.appendChild(opt);
    });
    priceSelect.style.display = 'block';
  } else priceSelect.style.display = 'none';
});

/* -------------------------
   Inventory helper UI
   ------------------------- */
function renderStockNote(){
  const lows = Object.entries(stock).filter(([,q])=>q<=3).slice(0,4);
  if(lows.length){
    stockNote.innerHTML = `<span class="low-stock">Low: ${lows.map(([i])=>i).join(', ')}</span>`;
  } else stockNote.textContent = '';
}

/* -------------------------
   Add item - decrements stock, adds to (table->subOrder)
   ------------------------- */
addItemBtn.addEventListener('click', async ()=>{
  const tableNum = tableSelect.value;
  const type = typeSelect.value;
  const itemName = itemSelect.value;
  const price = priceSelect.style.display==='block' ? parseInt(priceSelect.value) : (menuItems[type]||[]).find(m=>m.item===itemName)?.price[0];
  const qty = parseInt(quantityInput.value) || 1;
  const desc = (descriptionInput.value || 'Person').trim();

  if(!tableNum || !type || !itemName || !price || qty<1){
    alert('Select Table, Type, Item and Quantity.');
    return;
  }

  // check stock
  const available = (stock[itemName] === undefined) ? Infinity : stock[itemName];
  if(available !== Infinity && available < qty){
    alert(`Not enough stock for "${itemName}". Available: ${available}`);
    return;
  }

  // find or create table object
  let tableID = Object.keys(tables).find(id => tables[id].table == tableNum && tables[id].tableStatus === 'opened');
  if(!tableID){
    tableID = 'TABLE-'+Date.now();
    tables[tableID] = { id: tableID, table: tableNum, tableStatus:'opened', time: new Date().toISOString(), subOrders: [] };
  }
  const tableOrder = tables[tableID];

  // find or create sub-order by description
  let sub = tableOrder.subOrders.find(s => s.description === desc);
  if(!sub){
    sub = { personID: 'PERSON-'+Date.now(), description: desc, items: [], totalPrice: 0 };
    tableOrder.subOrders.push(sub);
  }

  // push item
  const newItem = { id: 'ITEM-'+Date.now(), item: itemName, price, quantity: qty, status:'pending', time: new Date().toISOString() };
  sub.items.push(newItem);
  sub.totalPrice = sub.items.reduce((s,i)=>s + i.price*i.quantity, 0);

  // decrement stock and save both
  if(stock[itemName] !== undefined && stock[itemName] !== Infinity){
    stock[itemName] = Math.max(0, (stock[itemName] || 0) - qty);
  }
  await saveStockToFirebase();
  await saveTablesToFirebase();

  quantityInput.value = 1;
  descriptionInput.value = '';
  renderTables();
});

/* -------------------------
   Render tables UI (main)
   ------------------------- */
function renderTables(){
  tablesContainer.innerHTML = '';
  Object.values(tables).filter(t=>t.tableStatus==='opened').sort((a,b)=>b.time.localeCompare(a.time)).forEach(tableOrder=>{
    const box = document.createElement('div'); box.className='table-box';
    const total = (tableOrder.subOrders||[]).reduce((s,sub)=>s + (sub.totalPrice||0), 0);
    box.innerHTML = `
      <div class="table-head">
        <div><strong>Table ${tableOrder.table}</strong></div>
        <div class="table-total">${total} mts</div>
      </div>
    `;

    // whole-table move controls
    const wholeControls = document.createElement('div'); wholeControls.className='controls-row';
    const moveSelect = document.createElement('select'); moveSelect.className='move-select';
    moveSelect.innerHTML = `<option value="" disabled selected>Move table</option>${[...Array(13)].map((_,i)=>`<option value="${i+1}">${i+1}</option>`).join('')}`;
    wholeControls.appendChild(moveSelect);
    const moveBtn = document.createElement('button'); moveBtn.className='small'; moveBtn.textContent='Move';
    moveBtn.addEventListener('click', async ()=>{
      const newTable = moveSelect.value;
      if(!newTable){ alert('Choose a table to move to'); return; }
      if(String(newTable) === String(tableOrder.table)){ alert('Already on that table'); return; }
      tableOrder.table = newTable;
      // if mergedHistory existed for old id, move it too under new id
      const oldID = tableOrder.id;
      await saveTablesToFirebase();
      // we must update mergedHistory key if exists
      if(mergedHistory[oldID]){
        mergedHistory['TABLE-'+Date.now()] = mergedHistory[oldID];
        delete mergedHistory[oldID];
      }
      renderTables();
    });
    wholeControls.appendChild(moveBtn);

    // Merge button (table-level) - show only if more than one sub-order and not already merged
    if((tableOrder.subOrders || []).length > 1 && !mergedHistory[tableOrder.id]){
      const mergeBtn = document.createElement('button'); mergeBtn.className='merge-btn small'; mergeBtn.textContent='Merge';
      mergeBtn.addEventListener('click', async ()=>{
        // backup original subOrders
        mergedHistory[tableOrder.id] = JSON.parse(JSON.stringify(tableOrder.subOrders));
        // create ONE merged sub-order (TRUE MERGE)
        const mergedItems = [];
        tableOrder.subOrders.forEach(s => mergedItems.push(...s.items));
        const mergedSub = {
          personID: 'PERSON-'+Date.now(),
          description: 'Merged Order',
          items: mergedItems,
          totalPrice: mergedItems.reduce((s,i)=>s + i.price*i.quantity,0)
        };
        tableOrder.subOrders = [mergedSub];
        await saveTablesToFirebase();
        renderTables();
      });
      wholeControls.appendChild(mergeBtn);
    }

    // Split button (table-level) - show only if table has a mergedHistory backup
    if(mergedHistory[tableOrder.id]){
      const splitBtn = document.createElement('button'); splitBtn.className='split-btn small'; splitBtn.textContent='Split';
      splitBtn.addEventListener('click', async ()=>{
        // restore exact previous sub-orders
        tableOrder.subOrders = JSON.parse(JSON.stringify(mergedHistory[tableOrder.id]));
        delete mergedHistory[tableOrder.id];
        await saveTablesToFirebase();
        renderTables();
      });
      wholeControls.appendChild(splitBtn);
    }

    box.appendChild(wholeControls);

    // render sub-orders (if merged, tableOrder.subOrders will be single merged sub)
    (tableOrder.subOrders || []).forEach((sub, subIndex) => {
      const p = document.createElement('div'); p.className='person-box';
      p.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center"><div><strong>${sub.description}</strong></div><div>${sub.totalPrice||0} mts</div></div>`;

      // controls for this sub-order: move it to another table
      const controls = document.createElement('div'); controls.className='person-actions';
      const moveS = document.createElement('select'); moveS.className='move-select';
      moveS.innerHTML = `<option value="" disabled selected>Move sub-order</option>${[...Array(13)].map((_,i)=>`<option value="${i+1}">${i+1}</option>`).join('')}`;
      controls.appendChild(moveS);
      const moveSBtn = document.createElement('button'); moveSBtn.className='small'; moveSBtn.textContent='Move';
      moveSBtn.addEventListener('click', async ()=>{
        const newTable = moveS.value;
        if(!newTable){ alert('Choose a table to move to'); return; }
        if(String(newTable) === String(tableOrder.table)){ alert('Already on that table'); return; }
        // deep copy sub
        const moved = JSON.parse(JSON.stringify(sub));
        // remove sub from current table
        tableOrder.subOrders.splice(subIndex,1);
        if(!tableOrder.subOrders.length) delete tables[tableOrder.id];

        // find or create target table
        let targetID = Object.keys(tables).find(id => tables[id].table == newTable && tables[id].tableStatus === 'opened');
        if(!targetID){
          targetID = 'TABLE-'+Date.now();
          tables[targetID] = { id: targetID, table: newTable, tableStatus:'opened', time: new Date().toISOString(), subOrders: [] };
        }
        tables[targetID].subOrders.push(moved);

        // if we moved from a merged table and mergedHistory exists, remove mergedHistory for that old table ID (no longer valid)
        if(mergedHistory[tableOrder.id]) delete mergedHistory[tableOrder.id];

        await saveTablesToFirebase();
        renderTables();
      });
      controls.appendChild(moveSBtn);
      p.appendChild(controls);

      // items inside sub-order
      sub.items.forEach((it, itIndex) => {
        const itemDiv = document.createElement('div');
        itemDiv.className = 'item-box ' + (it.status === 'pending' ? 'pending' : 'served');
        itemDiv.innerHTML = `
          <div style="min-width:150px">
            <div><strong>${it.item} x${it.quantity}</strong></div>
            <div style="font-size:13px;color:#555">[${it.status}]</div>
          </div>
          <div style="text-align:right">
            <div style="font-weight:700">${it.price * it.quantity} mts</div>
            <div style="margin-top:6px">
              ${it.status === 'pending' ? `<button class="served-btn small">Served</button>` : ''}
              <button class="cancel-btn small">Cancel</button>
            </div>
          </div>
        `;
        // served handler
        if(it.status === 'pending'){
          itemDiv.querySelector('.served-btn').addEventListener('click', async ()=>{
            it.status = 'served';
            await saveTablesToFirebase();
            renderTables();
          });
        }
        // cancel handler
        itemDiv.querySelector('.cancel-btn').addEventListener('click', async ()=>{
          // return stock (undo)
          if(stock[it.item] !== undefined && stock[it.item] !== Infinity){
            stock[it.item] = (stock[it.item] || 0) + it.quantity;
            await saveStockToFirebase();
          }
          // remove item
          const idx = sub.items.findIndex(x=>x.id === it.id);
          if(idx !== -1) sub.items.splice(idx,1);
          sub.totalPrice = sub.items.reduce((s,i)=>s + i.price*i.quantity, 0);
          // if no items left in sub, remove sub
          if(sub.items.length === 0){
            const sIndex = tableOrder.subOrders.findIndex(sx => sx.personID === sub.personID);
            if(sIndex !== -1) tableOrder.subOrders.splice(sIndex,1);
          }
          if(tableOrder.subOrders.length === 0) delete tables[tableOrder.id];
          await saveTablesToFirebase();
          renderTables();
        });

        p.appendChild(itemDiv);
      });

      box.appendChild(p);
    });

    // close table button (only if all served)
    const closeBtn = document.createElement('button'); closeBtn.className='small'; closeBtn.textContent='Close Table';
    closeBtn.addEventListener('click', async ()=>{
      if(tableOrder.subOrders.some(s => s.items.some(it => it.status === 'pending'))){
        alert('All items must be served before closing'); return;
      }
      tableOrder.tableStatus = 'closed';
      if(mergedHistory[tableOrder.id]) delete mergedHistory[tableOrder.id];
      await saveTablesToFirebase();
      renderTables();
    });
    box.appendChild(closeBtn);

    tablesContainer.appendChild(box);
  });

  renderStockNote();
}

/* -------------------------
   helpers: save stock
   ------------------------- */
async function saveStockToFirebase(){
  await setDoc(stockDocRef, { stock });
}

</script>
</body>
</html>

