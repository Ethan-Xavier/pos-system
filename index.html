<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Advanced POS</title>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
<style>
body{font-family:sans-serif;background:#f4f4f4;padding:20px;display:flex;flex-direction:column;align-items:center;gap:12px}
.order-box{background:#0062ca;padding:18px;border-radius:12px;color:#fff;width:380px;box-shadow:0 4px 15px rgba(0,0,0,.2)}
.order-box h2{text-align:center;margin:0 0 10px}
input,select,button{width:100%;padding:8px;margin:5px 0;border-radius:6px;border:none;font-size:14px;outline:none}
button{cursor:pointer;font-weight:bold}
.add-btn{background:#28a745;color:#fff}
.serve-btn{background:#007bff;color:#fff}
.cancel-btn{background:#dc3545;color:#fff}
.tables-container{width:380px;display:flex;flex-direction:column;gap:10px}
.table-box{background:#fff;padding:12px;border-radius:10px;position:relative}
.person-box{background:#f0f0f0;padding:8px;border-radius:8px;margin-bottom:6px;display:flex;flex-direction:column;gap:4px}
.item-box{display:flex;justify-content:space-between;margin:2px 0;padding:4px;background:#eee;border-radius:4px;gap:4px;align-items:center}
.table-controls{display:flex;gap:4px;margin-top:6px;flex-wrap:wrap}
.modal-bg{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.5);display:none;justify-content:center;align-items:center}
.modal{background:#fff;padding:20px;border-radius:12px;width:320px;max-height:80%;overflow:auto;display:flex;flex-direction:column;gap:12px}
.modal h3{text-align:center;margin:0}
</style>
</head>
<body>

<div class="order-box">
<h2><i class="fas fa-utensils"></i> Advanced POS</h2>

<label>Table</label>
<select id="tableSelect"><option value="" disabled selected>Select table</option></select>

<label>Description</label>
<input id="descriptionInput" placeholder="e.g. John / Veggie" />

<label>Type</label>
<select id="typeSelect">
  <option value="" disabled selected>Select type</option>
  <option value="food">Food</option>
  <option value="drink">Drink</option>
</select>

<label>Item</label>
<select id="itemSelect"><option value="" disabled selected>Select item</option></select>

<label>Quantity</label>
<input id="quantityInput" type="number" min="1" value="1">

<button id="addItemBtn" class="add-btn">Add Item</button>
</div>

<div class="tables-container" id="tablesContainer"></div>

<!-- Payment Modal -->
<div id="paymentModal" class="modal-bg">
<div class="modal">
<h3>Payment</h3>
<div id="paymentContent"></div>
<label>Method</label>
<select id="paymentMethod">
<option value="" disabled selected>Select method</option>
<option value="cash">Cash</option>
<option value="card">Card</option>
<option value="mobile">Mobile</option>
</select>
<button id="payBtn" style="background:#28a745;color:#fff">Pay</button>
<button id="closeModalBtn">Close</button>
</div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "YOUR_API_KEY",
  authDomain: "YOUR_DOMAIN",
  projectId: "YOUR_PROJECT_ID",
  storageBucket: "YOUR_BUCKET",
  messagingSenderId: "YOUR_SENDER_ID",
  appId: "YOUR_APP_ID"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const posDocRef = doc(db, 'posData', 'pos');

const tableSelect = document.getElementById('tableSelect');
const descriptionInput = document.getElementById('descriptionInput');
const typeSelect = document.getElementById('typeSelect');
const itemSelect = document.getElementById('itemSelect');
const quantityInput = document.getElementById('quantityInput');
const addItemBtn = document.getElementById('addItemBtn');
const tablesContainer = document.getElementById('tablesContainer');

const paymentModal = document.getElementById('paymentModal');
const paymentContent = document.getElementById('paymentContent');
const paymentMethod = document.getElementById('paymentMethod');
const payBtn = document.getElementById('payBtn');
const closeModalBtn = document.getElementById('closeModalBtn');

let posData = { openTables: [], closedTables: [] };

const menuItems = {
  food: [{item:'Pizza',price:500},{item:'Pasta',price:300},{item:'Burger',price:200}],
  drink: [{item:'Soda',price:50},{item:'Juice',price:80},{item:'Water',price:30}]
};

// Init table options
for(let i=1;i<=13;i++){
  const opt=document.createElement('option'); opt.value=i; opt.textContent=i;
  tableSelect.appendChild(opt);
}

// Update items when type changes
typeSelect.addEventListener('change',()=>{
  itemSelect.innerHTML='<option value="" disabled selected>Select item</option>';
  menuItems[typeSelect.value].forEach(i=>{
    const opt=document.createElement('option');
    opt.value=i.item; opt.dataset.price=i.price;
    opt.textContent = `${i.item} - ${i.price} mts`;
    itemSelect.appendChild(opt);
  });
});

async function savePOS(){ await setDoc(posDocRef, posData); }

onSnapshot(posDocRef, snap=>{
  posData = snap.data()||{openTables:[],closedTables:[]};
  renderTables();
});

// Add order
addItemBtn.addEventListener('click', async()=>{
  const tableNum = tableSelect.value;
  const desc = (descriptionInput.value||'Customer').trim();
  const type = typeSelect.value;
  const itemName = itemSelect.value;
  const price = parseInt(itemSelect.selectedOptions[0].dataset.price);
  const qty = parseInt(quantityInput.value)||1;

  if(!tableNum || !itemName || !type){ alert('Select table, type, and item'); return; }

  let table = posData.openTables.find(t=>t.tableNumber==tableNum);
  if(!table){
    table = {id:'TABLE-'+Date.now(), tableNumber:tableNum, timeOpened:new Date().toISOString(),
      timeClosed:null, people:[], tableTotal:0, merged:false};
    posData.openTables.push(table);
  }

  let person = table.people.find(p=>p.description===desc);
  if(!person){
    person = {id:'PERSON-'+Date.now(), description:desc, orders:[], totalPrice:0, payment:null};
    table.people.push(person);
  }

  person.orders.push({item:itemName,price,quantity:qty,status:'pending',paid:false});
  person.totalPrice = person.orders.reduce((s,o)=>s+o.price*o.quantity,0);
  table.tableTotal = table.people.reduce((s,p)=>s+p.totalPrice,0);

  await savePOS();
  quantityInput.value=1; descriptionInput.value='';
});

// Render tables
function renderTables(){
  tablesContainer.innerHTML='';
  posData.openTables.forEach(table=>{
    const box=document.createElement('div'); box.className='table-box';

    // Header
    const header=document.createElement('div');
    header.innerHTML=`<strong>Table ${table.tableNumber}</strong> - Total: ${table.tableTotal} mts`;
    if(table.merged){ header.innerHTML += ' <span style="color:#007bff;font-weight:700">Merged</span>'; }
    box.appendChild(header);

    table.people.forEach(person=>{
      const personDiv=document.createElement('div'); personDiv.className='person-box';
      const title=document.createElement('div');
      title.innerHTML=`<strong>${person.description}</strong> - ${person.totalPrice} mts`;
      if(person.payment){ title.innerHTML += ' <span style="color:#28a745;font-weight:600">Paid</span>'; }
      personDiv.appendChild(title);

      person.orders.forEach(order=>{
        const orderDiv=document.createElement('div'); orderDiv.className='item-box';
        orderDiv.textContent = `${order.item} x${order.quantity} - ${order.price*order.quantity} mts`;

        if(order.status!=='served'){
          const serveBtn=document.createElement('button'); serveBtn.className='serve-btn'; serveBtn.textContent='Serve';
          serveBtn.onclick=async()=>{ order.status='served'; await savePOS(); };
          orderDiv.appendChild(serveBtn);
        }

        const cancelBtn=document.createElement('button'); cancelBtn.className='cancel-btn'; cancelBtn.textContent='Cancel';
        cancelBtn.onclick = async () => {
          person.orders = person.orders.filter(o=>o!==order);
          person.totalPrice = person.orders.reduce((s,o)=>s+o.price*o.quantity,0);
          if(person.orders.length===0){ table.people = table.people.filter(p=>p!==person); }
          table.tableTotal = table.people.reduce((s,p)=>s+p.totalPrice,0);
          await savePOS();
        };

        orderDiv.appendChild(cancelBtn);
        personDiv.appendChild(orderDiv);
      });

      // Pay separately
      if(person.orders.some(o=>!o.paid)){
        const payBtn=document.createElement('button'); payBtn.className='add-btn'; payBtn.textContent='Pay';
        payBtn.onclick=()=>{ showPayment(table, person); };
        personDiv.appendChild(payBtn);
      }

      // Move person
      const moveBtn=document.createElement('button'); moveBtn.textContent='Move Person';
      moveBtn.onclick=async()=>{
        const newTableNum = prompt("Enter target table number:");
        if(!newTableNum) return;
        let targetTable = posData.openTables.find(t => t.tableNumber==newTableNum);
        if(!targetTable){
          targetTable = {id:'TABLE-'+Date.now(), tableNumber:newTableNum, timeOpened:new Date().toISOString(), timeClosed:null, people:[], tableTotal:0, merged:false};
          posData.openTables.push(targetTable);
        }
        table.people = table.people.filter(p=>p!==person);
        targetTable.people.push(person);
        table.tableTotal = table.people.reduce((s,p)=>s+p.totalPrice,0);
        targetTable.tableTotal = targetTable.people.reduce((s,p)=>s+p.totalPrice,0);
        await savePOS();
      };
      personDiv.appendChild(moveBtn);

      personDiv && box.appendChild(personDiv);
    });

    // Table controls
    const controlsDiv = document.createElement('div'); controlsDiv.className='table-controls';

    // Merge tables
    if(!table.merged && posData.openTables.length > 1){
      const mergeBtn = document.createElement('button'); mergeBtn.textContent='Merge Table';
      mergeBtn.onclick=async()=>{
        const otherTableNum = prompt("Enter table number to merge with:");
        const otherTable = posData.openTables.find(t=>t.tableNumber==otherTableNum && t!==table);
        if(!otherTable){ alert("Invalid table"); return; }
        table.people = table.people.concat(otherTable.people);
        table.tableTotal = table.people.reduce((s,p)=>s+p.totalPrice,0);
        table.merged = true;
        posData.openTables = posData.openTables.filter(t=>t!==otherTable);
        await savePOS();
      };
      controlsDiv.appendChild(mergeBtn);
    }

    // Split merged table
    if(table.merged && table.people.length > 1){
      const splitBtn = document.createElement('button'); splitBtn.textContent='Split Table';
      splitBtn.onclick=async()=>{
        table.people.forEach(person=>{
          let nextTableNum = 1;
          while(posData.openTables.some(t=>t.tableNumber==nextTableNum)) nextTableNum++;
          const newTable = {id:'TABLE-'+Date.now()+'-'+person.id, tableNumber: nextTableNum, timeOpened: table.timeOpened, timeClosed:null, people:[person], tableTotal: person.totalPrice, merged:false};
          posData.openTables.push(newTable);
        });
        posData.openTables = posData.openTables.filter(t=>t!==table);
        await savePOS();
      };
      controlsDiv.appendChild(splitBtn);
    }

    // Merge bills within table
    if(table.people.length > 1){
      const mergeBillsBtn = document.createElement('button'); mergeBillsBtn.textContent='Merge Bills';
      mergeBillsBtn.onclick=async()=>{
        const mergedPerson = {id:'PERSON-'+Date.now(), description:'Merged', orders:[], totalPrice:0, payment:null};
        table.people.forEach(p=>{
          mergedPerson.orders = mergedPerson.orders.concat(p.orders);
          mergedPerson.totalPrice += p.totalPrice;
        });
        table.people = [mergedPerson];
        table.tableTotal = mergedPerson.totalPrice;
        table.merged = true;
        await savePOS();
      };
      controlsDiv.appendChild(mergeBillsBtn);
    }

    // Split merged bills
    if(table.people.length === 1 && table.people[0].description==='Merged'){
      const splitBillsBtn = document.createElement('button');
      splitBillsBtn.textContent='Split Bills';
      splitBillsBtn.onclick=async()=>{
        const mergedPerson = table.people[0];
        const originalPeople = mergedPerson.orders.map((o,i)=>({
          id:'PERSON-'+Date.now()+'-'+i,
          description:'Person '+(i+1),
          orders:[o],
          totalPrice:o.price*o.quantity,
          payment:null
        }));
        table.people = originalPeople;
        table.tableTotal = table.people.reduce((s,p)=>s+p.totalPrice,0);
        table.merged=false;
        await savePOS();
      };
      controlsDiv.appendChild(splitBillsBtn);
    }

    // Move table
    const moveTableBtn = document.createElement('button'); moveTableBtn.textContent='Move Table';
    moveTableBtn.onclick=async()=>{
      const newTableNum = prompt("Enter new table number:");
      if(!newTableNum) return;
      if(posData.openTables.some(t=>t.tableNumber == newTableNum)){ alert("Table exists"); return; }
      table.tableNumber = newTableNum;
      await savePOS();
    };
    controlsDiv.appendChild(moveTableBtn);

    box.appendChild(controlsDiv);
    tablesContainer.appendChild(box);
  });
}

// Payment modal
function showPayment(table, person){
  paymentModal.style.display='flex';
  paymentContent.innerHTML=`<strong>${person.description}</strong> - ${person.totalPrice} mts`;
  payBtn.onclick=async()=>{
    const method = paymentMethod.value;
    if(!method){ alert('Select payment method'); return; }
    person.orders.forEach(o=>{ o.paid=true; o.status='served'; });
    person.payment = {method, amount: person.totalPrice};
    if(person.orders.every(o=>o.paid)){ table.people = table.people.filter(p=>p!==person); }
    if(table.people.length===0){
      table.timeClosed=new Date().toISOString();
      posData.closedTables.push(table);
      posData.openTables = posData.openTables.filter(t=>t!==table);
    }
    await savePOS();
    paymentModal.style.display='none';
  };
  closeModalBtn.onclick=()=>{ paymentModal.style.display='none'; };
}
</script>
</body>
</html>
