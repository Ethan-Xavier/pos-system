<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>POS — Input & Table Structure (Demo)</title>
  <style>
    body { font-family: system-ui, Arial; padding: 24px; max-width:800px; margin:0 auto; }
    label{display:block;margin-top:10px;font-weight:600}
    input, select, button { padding:8px; font-size:14px; width:100%; box-sizing:border-box }
    .row{display:flex;gap:8px}
    .row > *{flex:1}
    .card{border:1px solid #eee;padding:12px;border-radius:8px;margin-top:12px}
    pre{background:#f7f7f7;padding:12px;border-radius:6px;overflow:auto}

    .table-box{
      border:1px solid #aaa;
      border-radius:8px;
      padding:12px;
      margin-bottom:12px;
      background:#fdfdfd;
    }

    .table-title{
      font-weight:700;
      font-size:16px;
      margin-bottom:6px;
      color:#333;
      cursor:pointer;
    }

    .order-tag-box{
      border:1px solid #bbb;
      border-radius:6px;
      padding:6px;
      margin:6px 0;
      background:#eef;
    }

    .tag-header{
      font-weight:600;
      display:flex;
      justify-content:space-between;
      align-items:center;
      cursor:pointer;
    }

    .tag-buttons{
      display:flex;
      gap:6px;
    }

    .order-box{
      border:1px solid #ccc;
      border-radius:6px;
      padding:6px;
      margin:4px 0;
      background:#f7f7ff
    }

    .order-total{
      margin-top:4px;
      font-weight:600;
      text-align:right;
    }

    .btn-cancel{
      background:#d9534f;
      color:white;
      border:none;
      padding:5px 8px;
      border-radius:4px;
      cursor:pointer;
      width:auto;
    }

    .btn-pay{
      background:#5cb85c;
      color:white;
      border:none;
      padding:5px 8px;
      border-radius:4px;
      cursor:pointer;
      width:auto;
    }

    .btn-move{
      background:#0275d8;
      color:white;
      border:none;
      padding:5px 8px;
      border-radius:4px;
      cursor:pointer;
      width:auto;
    }

    /* POPUP */
    #payPopup{
      position:fixed;
      top:0;left:0;
      width:100%;height:100%;
      background:rgba(0,0,0,0.5);
      display:none;
      align-items:center;
      justify-content:center;
    }
    #payPopupContent{
      background:white;
      padding:20px;
      border-radius:8px;
      width:300px;
    }
    #payPopup h3{margin-top:0}
  </style>
</head>
<body>
  <h2>POS — Input (Demo)</h2>

  <!-- INPUT AREA -->
  <div class="card">
    <label for="tableDesc">Table Description (required)</label>
    <input id="tableDesc" placeholder="Table 1 / John - Table / Window seat" required />

    <label for="orderTag">Order Tag</label>
    <input id="orderTag" placeholder="Single Order" value="Single Order" />

    <div class="row">
      <div>
        <label for="section">Section</label>
        <select id="section">
          <option value="Food">Food</option>
          <option value="Drinks">Drinks</option>
        </select>
      </div>

      <div>
        <label for="item">Item</label>
        <select id="item"></select>
      </div>

      <div style="max-width:110px">
        <label for="qty">Qty</label>
        <input id="qty" type="number" min="1" value="1" />
      </div>
    </div>

    <button id="placeOrderBtn">Place order</button>
  </div>

  <!-- TABLES -->
  <div class="card">
    <h3>Tables & Orders</h3>
    <div id="tables"></div>
  </div>

  <!-- SNAPSHOT MOVED BELOW -->
  <div class="card">
    <h3>posData (current snapshot)</h3>
    <pre id="snapshot">(no orders yet)</pre>
  </div>

  <!-- PAYMENT POPUP -->
  <div id="payPopup">
    <div id="payPopupContent">
      <h3>Confirm Payment</h3>
      <div id="payDetails"></div>

      <label>Payment Method:</label>
      <select id="paymentMethod">
        <option value="cash">Cash</option>
        <option value="card">Card</option>
        <option value="mobile">Mobile</option>
      </select>

      <button id="confirmPay" class="btn-pay" style="margin-top:10px;width:100%">Confirm</button>
      <button id="cancelPay" class="btn-cancel" style="margin-top:6px;width:100%">Cancel</button>
    </div>
  </div>

<script>
const MENU = { 
  Food: [
    {name:"Burger", price:5},
    {name:"Pizza", price:8},
    {name:"Salad", price:4},
    {name:"Pasta", price:7}
  ],
  Drinks: [
    {name:"Water", price:1},
    {name:"Soda", price:2},
    {name:"Coffee", price:3},
    {name:"Juice", price:3}
  ]
};

const posData = { openOrders: [], closedOrders: [], problemOrders: [] };
const $ = id => document.getElementById(id);
const snapshotEl = $('snapshot');

function populateItems(section){
  const itemSelect = $('item');
  itemSelect.innerHTML = '';
  MENU[section].forEach(it => {
    const opt = document.createElement('option');
    opt.value = it.name;
    opt.textContent = `${it.name} - $${it.price}`;
    itemSelect.appendChild(opt);
  });
}

function getItemPrice(section, itemName){
  const found = MENU[section].find(i => i.name === itemName);
  return found ? found.price : 0;
}

function uid(prefix = ''){
  return prefix + Date.now().toString(36) + Math.random().toString(36).slice(2,7);
}

function updateSnapshot(){ 
  snapshotEl.textContent = JSON.stringify(posData, null, 2); 
}

function findTable(desc){
  return posData.openOrders.find(t => t.tableDescription === desc);
}

function placeOrder({tableDescription, orderTag, section, item, qty}){
  const timestamp = new Date().toISOString();

  let table = findTable(tableDescription);
  if(!table){
    table = {
      tableId: uid('TBL-'),
      tableDescription,
      status:'occupied',
      createdAt: timestamp,
      orders: []
    };
    posData.openOrders.push(table);
  }

  let tagOrder = table.orders.find(t => t.orderTag === orderTag);
  if(!tagOrder){
    tagOrder = { orderTag: orderTag || 'Single Order', items: [] };
    table.orders.push(tagOrder);
  }

  const existingItem = tagOrder.items.find(i => i.item === item);
  if(existingItem){
    existingItem.qty += Number(qty);
  } else {
    tagOrder.items.push({
      item,
      qty:Number(qty),
      price:getItemPrice(section, item),
      timestampCreated: timestamp,
      orderStatus:'open'
    });
  }

  updateSnapshot();
  renderTables();
}

/* ========== MOVE ORDER TAG ========== */
function moveOrderTag(table, tag){
  const newTableDesc = prompt("Move to which Table Description?");
  if(!newTableDesc) return;

  let destTable = findTable(newTableDesc);
  if(!destTable){
    destTable = {
      tableId: uid('TBL-'),
      tableDescription:newTableDesc,
      status:'occupied',
      createdAt:new Date().toISOString(),
      orders:[]
    };
    posData.openOrders.push(destTable);
  }

  table.orders = table.orders.filter(t => t !== tag);
  destTable.orders.push(tag);

  if(table.orders.length === 0){
    posData.openOrders = posData.openOrders.filter(t => t !== table);
  }

  updateSnapshot();
  renderTables();
}

/* ======== PAYMENT POPUP HANDLING ======== */
let currentPayTable = null;
let currentPayTag = null;

function openPayPopup(table, tag){
  currentPayTable = table;
  currentPayTag = tag;

  $("payDetails").innerHTML = `
    <strong>Order Tag:</strong> ${tag.orderTag}<br>
    <strong>Total Items:</strong> ${tag.items.length}
  `;

  $("payPopup").style.display = "flex";
}

$("cancelPay").onclick = () => {
  $("payPopup").style.display = "none";
};

$("confirmPay").onclick = () => {
  const method = $("paymentMethod").value;

  currentPayTag.items.forEach(item => {
    posData.closedOrders.push({
      item: item.item,
      qty: item.qty,
      price: item.price,
      timestampCreated: item.timestampCreated,
      paymentMethod: method,
      originalOrderTag: currentPayTag.orderTag
    });
  });

  currentPayTable.orders = currentPayTable.orders.filter(t => t !== currentPayTag);
  if(currentPayTable.orders.length === 0){
    posData.openOrders = posData.openOrders.filter(t => t !== currentPayTable);
  }

  $("payPopup").style.display = "none";

  updateSnapshot();
  renderTables();
};

/* ========== RENDER TABLES ========== */
function renderTables(){
  const container = $('tables');
  container.innerHTML = '';

  posData.openOrders.forEach(table => {
    const tableDiv = document.createElement('div');
    tableDiv.className = 'table-box';

    const titleDiv = document.createElement('div');
    titleDiv.className = 'table-title';
    titleDiv.textContent = table.tableDescription;

    titleDiv.onclick = () => {
      const newDesc = prompt("Edit Table Description", table.tableDescription);
      if(newDesc){
        table.tableDescription = newDesc;
        updateSnapshot();
        renderTables();
      }
    };

    tableDiv.appendChild(titleDiv);

    table.orders.forEach(tag => {
      const tagDiv = document.createElement('div');
      tagDiv.className = "order-tag-box";

      const header = document.createElement('div');
      header.className = 'tag-header';

      /* Editable text */
      const titleSpan = document.createElement('span');
      titleSpan.textContent = tag.orderTag;
      titleSpan.onclick = () => {
        const newTag = prompt("Edit Order Tag", tag.orderTag);
        if(newTag){
          tag.orderTag = newTag;
          updateSnapshot();
          renderTables();
        }
      };

      const btns = document.createElement('div');
      btns.className = 'tag-buttons';

      const moveBtn = document.createElement('button');
      moveBtn.className = 'btn-move';
      moveBtn.textContent = "Move";
      moveBtn.onclick = () => moveOrderTag(table, tag);

      const cancelBtn = document.createElement('button');
      cancelBtn.className = 'btn-cancel';
      cancelBtn.textContent = "Cancel";
      cancelBtn.onclick = () => {
        table.orders = table.orders.filter(o => o !== tag);
        if(table.orders.length === 0){
          posData.openOrders = posData.openOrders.filter(t => t !== table);
        }
        updateSnapshot();
        renderTables();
      };

      const payBtn = document.createElement('button');
      payBtn.className = 'btn-pay';
      payBtn.textContent = "Pay";
      payBtn.onclick = () => openPayPopup(table, tag);

      btns.append(moveBtn, cancelBtn, payBtn);

      header.append(titleSpan, btns);
      tagDiv.appendChild(header);

      tag.items.forEach(i => {
        const orderDiv = document.createElement('div');
        orderDiv.className = 'order-box';
        orderDiv.textContent = `${i.item} x ${i.qty} - $${i.price}`;
        tagDiv.appendChild(orderDiv);
      });

      const total = tag.items.reduce((s,i)=>s+i.qty*i.price,0);
      const totalDiv = document.createElement('div');
      totalDiv.className = "order-total";
      totalDiv.textContent = `Total: $${total}`;
      tagDiv.appendChild(totalDiv);

      tableDiv.appendChild(tagDiv);
    });

    container.appendChild(tableDiv);
  });
}

$("section").addEventListener("change", e => populateItems(e.target.value));
populateItems($("section").value);

$("placeOrderBtn").addEventListener("click", () => {
  const tableDescription = $('tableDesc').value.trim();
  if(!tableDescription){ alert("Table Description required"); return; }

  placeOrder({
    tableDescription,
    orderTag:$("orderTag").value.trim() || "Single Order",
    section:$("section").value,
    item:$("item").value,
    qty:$("qty").value
  });

  $("orderTag").value = "Single Order";
  $("qty").value = 1;
});

updateSnapshot();
renderTables();
</script>
</body>
</html>
